---
title: "732A98-Visualization Lab 1"
author: 
  - Qinyuan Qi(qinqi464)
date: "`r Sys.Date()`"
header-includes:
  - \usepackage{pdfpages}
output: html_document
runtime: shiny
---

# Assignment 1

The modified graph is as follows.
Plot generated by tree package and saved to an SVG file, then edited by Inkscape.
To be included in Rmd, it is converted to a vector based pdf file, then use 
iframe to include the pdf inside the report.

The result is as follows.

<iframe src="tree.pdf" style="width:100%; height:78vh"></iframe>

# Assignment 2

Please check appendix for the code.

```{r setup2, include=FALSE, echo=FALSE}
###########################  Init code For Assignment 2 ########################
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
```

## 2.1 Read file
Please check appendix for the code.
```{r 2.1, echo=FALSE}
###########################  Code For Assignment 2.1 ###########################
# read data
# since there have different space count between columns, we use  read.table and use fill=TRUE
data <- read.table("SENIC.txt", header = FALSE, fill = TRUE)

# Assign column names
colnames(data) <- c("ID", "X1", "X2", "X3", "X4", "X5", "X6", "X7", "X8", "X9", "X10", "X11")

# Convert columns to appropriate types
data$ID <- as.integer(data$ID)
data$X1 <- as.numeric(data$X1)
data$X2 <- as.numeric(data$X2)
data$X3 <- as.numeric(data$X3)
data$X4 <- as.numeric(data$X4)
data$X5 <- as.numeric(data$X5)
data$X6 <- as.numeric(data$X6)
data$X7 <- as.integer(data$X7)
data$X8 <- as.integer(data$X8)
data$X9 <- as.integer(data$X9)
data$X10 <- as.integer(data$X10)
data$X11 <- as.numeric(data$X11)
```

## 2.2 Calculate outlier observations

Please check appendix for the code.
```{r 2.2, echo=FALSE}
###########################  Code For Assignment 2.2 ###########################
calc_outlier_observations <- function(x) {

  # Compute the first and third quartiles
  Q1 <- quantile(x, 0.25)
  Q3 <- quantile(x, 0.75)
  IQR <- Q3 - Q1
  lower_bound <- Q1 - 1.5 * IQR
  upper_bound <- Q3 + 1.5 * IQR
  
  outlier_indices <- which(x < lower_bound | x > upper_bound)  # Return Outlier indies
  return(outlier_indices)
}  

# get the Infection Risk Outlier
x3_outliers <- data$X3[calc_outlier_observations(data$X3)]

df_outliers  <- data.frame(x = x3_outliers)

print("Outliers are:")
print(data$X3[x3_outliers])
```

## 2.3 Create a density plot of Infection risk in which outliers are plotted as a diamond symbol, and print outliers.

Please check appendix for the code.

```{r 2.3.1, echo=FALSE}
###########################  Code For Assignment 2.3 ###########################
library(ggplot2)

df <- data.frame(x = data$X3)

# plot 
graph2.3 <- ggplot(data = df, aes(x=x)) +
  geom_density(alpha = 0.5) +
  geom_point(data=df_outliers,aes(x=x,y=0),shape = 23, size = 3, fill = "blue") + 
  labs(title = 'Density plot of Infection risk', x = 'Infection risk') +
  theme(
    plot.title = element_text(hjust = 0.5)  # Center the title
  )

graph2.3
```

According to the graph and output above, we can see that the Infection risk follows some bell-shaped distribution, approximately a symmetric distribution. Outlier data are located in the 2 tails of this distribution.

## 2.4 Produce graphs of the same kind as in step 3 but for all other quantitative variables in the data

Please check appendix for the code.

```{r 2.4, echo=FALSE}
###########################  Code For Assignment 2.4 ###########################
library(gridExtra)

# generate column names
variables <- paste0("X", 1:11)

create_plot <- function(var_name,bw_val="nrd0") {
  # Calculate Outlier
  outliers <- data[[var_name]][calc_outlier_observations(data[[var_name]])]
  
  # Create data frames
  df <- data.frame(x = data[[var_name]])
  
  df_outliers <- data.frame(x = outliers)
  
  # Create the plot
  plot <- ggplot(data = df, aes(x = x)) +
    geom_density(alpha = 0.5,bw=bw_val) +
    labs(x = var_name,title =paste("Density Plot for ",var_name)) + 
    geom_point(data = df_outliers, aes(x = x, y = 0), shape = 23, size = 3, fill = "blue") +
    theme(
      plot.title = element_text(hjust = 0.5)  # Center the title
    )
  
  return(plot)
}

# Create a list of plots
plot_list <- lapply(variables, create_plot)

grid_layout <- arrangeGrob(grobs = plot_list, ncol = 3)

# Display the combined plot
grid.arrange(grid_layout)
```

According to the plots above , we can see that most of the columns data have outliers, but data of 
X8 and X11 do not have outliers

For X2,X3,X5,X11, the density function is almost symmetric.

For X1,X4,X6,X9,X10, the density function is asymmetric, and it has a positive skewness.

For X7, the  density function is asymmetric, and it has a negative skewness.

For X8, the  density function fluctuates over x, which means the density function 
might have multiple peaks and valleys, and it may following complex distribution
rather than simple and well-known distribution

## 2.5 Create a ggplot2 scatter plot showing the dependence of Infection risk on the Number of Nurses

Please check appendix for the code.

```{r 2.5, echo=FALSE}
###########################  Code For Assignment 2.5 ###########################

df <- data.frame(x = data$X10,y = data$X3, bed=data$X6)
graph2.5 <- ggplot(data = df) + 
  geom_point(aes(x=x,y=y,color=bed)) + 
  scale_color_gradient(low = "lightblue", high = "darkblue") +
  labs(title = 'Scatter Plot group by bed numbers', x = 'Nurse', y = 'Infection risk') +
  theme(
    plot.title = element_text(hjust = 0.5)  # Center the title
  )
graph2.5
```

The graph above shows that the bed number is positively related to the nurse number.
Also, we noticed that low infection risk happens when there are few nurses and beds, 
which may mean those small hospitals are most likely to handle low-risk patients, 
while those large hospitals will have more chance to handle high-risk patients.
For the possible danger of having such a colors. scale is that it is not suitable for those who are color blind or those who are not sensible to the colors. Meanwhile, since there exist lots of distinct bed numbers, which means the graph uses too many colors, it will make it hard for the user to identify very similar bed number points just by their colors.

So instead, we split the bed number to 5 equal groups and they will show the different color.

```{r 2.5.1, echo=FALSE}
##################Code For Assignment 2.5.1 Another approach ###########################

df <- data.frame(x = data$X10,y = data$X3, bed=data$X6)

# Group the bed variable into 4 categories
df$bed_group <- cut(df$bed, 
                    breaks = c(0, 200, 400, 600, 800,1000), 
                    labels = c("0-200", "201-400", "401-600", "601-800",">800"), 
                    include.lowest = TRUE)

graph2.5.1 <- ggplot(data = df) + 
  geom_point(aes(x=x,y=y,color = bed_group)) + 
  scale_color_manual(values = c("grey", "skyblue", "blue", "green","black")) + 
  labs(title = 'Scatter Plot group by bed numbers', x = 'Nurse', y = 'Infection risk') +
  theme(
    plot.title = element_text(hjust = 0.5)  # Center the title
  )
graph2.5.1
```

## 2.6 Convert graph from step 3 to Plotly with ggplotly function

Please check appendix for the code.

```{r 2.6, warning=FALSE, message=FALSE, echo=FALSE}
###########################  Code For Assignment 2.6 ###########################
library(plotly)
graph2.6 <- ggplotly(graph2.3)
graph2.6
```

From the above graph, we found that the graph embedded in the report can support user interaction, like zooming,scrolling etc. 

Compared to the graph in 2.3, there are two extra vertical lines at the beginning and end of the distribution which connect to 0.

## 2.7 Use pipeline operator to make a histogram of Infection risk, use diamond symbol when plot outliers

Please check appendix for the code.

We use pipeline to connect all the operations including data read,outliers calculation,histogram and outlier points etc.

```{r 2.7, warning=FALSE, echo=FALSE}
###########################  Code For Assignment 2.7 ###########################

graph2.7 <- read.table("SENIC.txt", header = FALSE, fill = TRUE) %>%
  # Assign column names
  setNames(c("ID", "X1", "X2", "X3", "X4", "X5", "X6", "X7", "X8", "X9", "X10", "X11")) %>%
  # Convert the X3 column to numeric
  mutate(X3 = as.numeric(X3)) %>%
  # Create a data frame with X3 and identify outliers
  data.frame(X3 = .$X3) %>%
  # since calc_outlier_observations return index, we need to use X3[index] here
  # also set those that are not outliers with value NA
  mutate(outliers = ifelse(X3 %in% X3[calc_outlier_observations(X3)], X3, NA)) %>%
  # Plotting with plotly
  plot_ly() %>%
  add_histogram(x = ~X3, 
                marker = list(color = 'gray'),
                showlegend = FALSE) %>%
  add_markers(x = ~outliers, y = 0, 
              marker = list(color = 'blue', size = 10, symbol = 'diamond'),
              name = 'Outliers') %>%
  layout(title = "Histogram with Outliers",
         xaxis = list(title = "X3"),
         yaxis = list(title = "Count"))
  
graph2.7
```

## 2.8 Shiny App to do same thing as step 2.4

Please check appendix for the code.

Shiny app is embedded in this html report.

```{r 2.8, echo=FALSE}
###########################  Code For Assignment 2.8 ###########################
library(shiny)

# Define UI for application
ui <- fluidPage(
    titlePanel("Shiny App"),
    tags$style(HTML("
        .main-panel {
            min-height: 800px;  /* Adjust this value to set the minimum height */
            overflow-y: visible; /* Ensure the content isn't cut off */
        }
    ")),
    sidebarLayout(
        sidebarPanel(
            # CheckboxGroupInput for features
          checkboxGroupInput("variables", "Select a variable:", 
                         choices = list("X1" = "X1",
                                        "X2" = "X2",
                                        "X3" = "X3",
                                        "X4" = "X4",
                                        "X5" = "X5",
                                        "X6" = "X6",
                                        "X7" = "X7",
                                        "X8" = "X8",
                                        "X9" = "X9",
                                        "X10" = "X10",
                                        "X11" = "X11"),
                         selected = c("X1","X2","X3","X4","X5","X6","X7","X8","X9","X10","X11")),  # Default selected values),
            sliderInput("bw",
                        "Value of bw:",
                        min = 0.1,
                        max = 15,
                        value = 3)
        ),
        
        mainPanel(
            plotOutput(outputId = "distPlot")
        )
    )
)

# Define server logic
server <- function(input, output, session) {
  
  output$distPlot <- renderPlot({
    # Check if at least one variable is selected
    req(input$variables)  # `req` will return early if input$variables is NULL or empty
    
    # Create a list of plots
    plot_list <- lapply(input$variables, create_plot, bw_val=input$bw)

    grid_layout <- arrangeGrob(grobs = plot_list, ncol = 3)

    # Display the combined plot
    graphs <- grid.arrange(grid_layout)
  
  })
}

# # Run the application 
shinyApp(ui = ui, server = server)
```

According to the plots above, we can not say which bandwidth suit all of the columns, 
because some of the density functions will fluctuates over X when we change feature,
but we found that when bandwidth value get larger, the density function will be smoother.

\newpage
# Appendix: All code for this report

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```